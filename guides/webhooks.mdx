# Webhooks Guide

Webhooks allow Unpod to send real-time event notifications to your application. This guide explains how to set up and handle webhooks effectively.

## Overview

Unpod webhooks notify your application about events such as:

- Call status changes (initiated, ringing, answered, completed)
- Message status updates (sent, delivered, failed)
- Call recordings available
- Call transcriptions ready

## Setting Up Webhooks

### 1. Configure Webhook URLs

Set webhook URLs in your account settings or specify them per request:

#### Account-Wide Webhooks

1. Go to **Settings** > **Webhooks**
2. Enter your webhook URLs for each event type
3. Save changes

#### Per-Request Webhooks

```javascript
// Set webhook URLs when making a call
const call = await unpod.calls.create({
  to: '+14155551234',
  from: '+14155556789',
  answerUrl: 'https://your-app.com/call/answer',
  statusCallback: 'https://your-app.com/call/status',
  recordingStatusCallback: 'https://your-app.com/call/recording',
  transcriptionStatusCallback: 'https://your-app.com/call/transcription'
});
```

## Webhook Security

### Signature Verification

All webhook requests include a signature in the `X-Unpod-Signature` header. Verify this signature to ensure the request is from Unpod.

#### Node.js Example

```javascript
import crypto from 'crypto';

export function verifyWebhook(signature, payload, secret) {
  const hmac = crypto.createHmac('sha256', secret);
  const expectedSignature = hmac.update(JSON.stringify(payload)).digest('hex');
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(expectedSignature, 'hex')
  );
}

// In your webhook handler
app.post('/webhook', express.json(), (req, res) => {
  const signature = req.headers['x-unpod-signature'];
  const payload = req.body;
  
  if (!verifyWebhook(signature, payload, process.env.UNPOD_WEBHOOK_SECRET)) {
    return res.status(401).send('Invalid signature');
  }
  
  // Process the webhook
  // ...
});
```

## Webhook Events

### Call Events

- `call.initiated`: A new call was initiated
- `call.ringing`: The call is ringing
- `call.answered`: The call was answered
- `call.completed`: The call ended
- `call.failed`: The call failed

### Message Events

- `message.queued`: Message is queued for delivery
- `message.sent`: Message was sent to the carrier
- `message.delivered`: Message was delivered to the recipient
- `message.failed`: Message delivery failed

### Recording Events

- `recording.completed`: Call recording is available
- `recording.failed`: Recording failed

### Transcription Events

- `transcription.completed`: Call transcription is available
- `transcription.failed`: Transcription failed

## Webhook Payloads

### Call Status Update

```json
{
  "event": "call.status",
  "callSid": "CA1234567890abcdef1234567890abcdef",
  "callStatus": "completed",
  "from": "+14155551234",
  "to": "+14155556789",
  "direction": "outbound",
  "duration": "45",
  "timestamp": "2023-06-15T12:00:00Z"
}
```

### Message Status Update

```json
{
  "event": "message.status",
  "messageSid": "SM1234567890abcdef1234567890abcdef",
  "status": "delivered",
  "from": "+14155556789",
  "to": "+14155551234",
  "body": "Hello from Unpod!",
  "timestamp": "2023-06-15T12:00:00Z"
}
```

## Handling Webhook Failures

Unpod implements an automatic retry mechanism for failed webhook deliveries:

1. First retry: 1 minute after failure
2. Second retry: 5 minutes after first retry
3. Subsequent retries: Exponential backoff up to 24 hours

After 24 hours, the webhook will be marked as failed and no further retries will be attempted.

## Testing Webhooks

### Using ngrok

1. Start ngrok to expose your local server:
   ```bash
   ngrok http 3000
   ```

2. Update your webhook URLs to use the ngrok URL:
   ```
   https://your-ngrok-url.ngrok.io/webhooks/call
   ```

### Using the Dashboard

1. Go to **Developer** > **Webhook Tester**
2. Select an event type
3. Click **Send Test**

## Best Practices

1. **Idempotency**: Design your webhook handlers to handle duplicate events
2. **Queue Processing**: Use a queue system to process webhooks asynchronously
3. **Logging**: Log all incoming webhook requests for debugging
4. **Timeouts**: Set appropriate timeouts for your webhook handlers
5. **Retry Logic**: Implement retry logic for transient failures

## Troubleshooting

### Common Issues

- **Webhook not received**: Check your server logs and firewall settings
- **Invalid signature**: Verify your webhook secret matches the one in your dashboard
- **Timeout errors**: Ensure your server responds within 30 seconds
- **Duplicate events**: Implement idempotency keys to handle retries

### Getting Help

If you're having trouble with webhooks, contact our support team at support@unpod.dev.
